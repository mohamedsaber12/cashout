{% extends 'new_base.html' %}
{% load static %}
{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% load custom_tags %}
{% load banks_tags i18n %}

{% block title %} {% trans 'Payment Links' %} {% endblock %}

{% block customcss %}
  <link href="{% static 'css/transaction_details.css' %}" rel="stylesheet">
  <style>
    .dialogButtonDiv {
        float: right
    }
    .errorlist {
      list-style: none;
      padding: 0;
    }
    .help-block {
      color: red;
    }
    .alert-success {
      color: #3c763d;
      background-color: #dff0d8;
      border-color: #d6e9c6;
    }
    .alert-danger {
      color: #a94442;
      background-color: #f2dede;
      border-color: #ebccd1;
    }
    ul > li > span{
      width: 160px;
    }
    #trxDetailsDataRight > li > span{
      width: 120px;
    }
    .export-dropdown {
      position: relative;
      display: inline-block;
      border: 0;
      background: transparent;
      border-radius: .5rem!important;
      width: 16rem!important;
      padding: .75rem!important;
      -webkit-box-shadow: 0 2px 8px 0 rgba(0,0,0,.14)!important;
      box-shadow: 0 2px 8px 0 rgba(0,0,0,.14)!important;
    }
    .pagination > li > span {
      width: 33px;
    }
    .successful {
      color:rgb(44, 119, 94);
      background-color: #cff3ee;
      margin: auto;
      padding: 5px;
      border-radius: 10px;
    }
    .pending {
      color: rgb(218, 127, 9);
      background-color: rgb(247, 229, 205);
      margin: auto;
      padding: 5px;
      border-radius: 10px;
    }
    .failed {
      color: rgb(255, 0, 0);
      background-color: #fdd7d7;
      margin: auto;
      padding: 5px;
      border-radius: 10px;
    }
    .border_radius {
      border-radius: 1rem;
    }
  </style>
  <!-- payment link details pdf css -->
  <link href="{% static 'css/transaction_details_pdf.css' %}" rel="stylesheet">
{% endblock %}

{% block body %}
  {# Page content #}
  <div class="col" role="main">
    <div class="">
      <div class="page-title">
        <div class="title_left">
          <h3>{% trans 'Payment Links' %}</h3>
        </div>
      </div>

      <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
          <div class="x_panel">
            <div class="x_title">
              <h2><strong>{% trans 'Payment Links Summary' %}</strong></h2>
              {% if user.is_checker or user.is_root %}
                {% if user.root.client.is_active %}
                  <div class="dialogButtonDiv pull-{{'right'|invert_dir:LANGUAGE_CODE}}">
                    <button id="addpaymentlink" class="btn btn-primary">{% trans 'Make New Payment Link' %}</button>
                  </div>
                {% else %}
                  <div class="alert alert-danger pull-{{'right'|invert_dir:LANGUAGE_CODE}}" role="alert">
                    {% trans "Your Entity is deactivated" %} <span class="glyphicon glyphicon-remove"></span>
                  </div>
                {% endif %}
              {% endif %}
              <ul class="nav navbar-right panel_toolbox">
                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                </li>
              </ul>
              <div class="clearfix"></div>
            </div>

            <div class="x_content">
              <table class="table table-bordered" id="transaction-table">
                <thead>
                    <tr>
                      <th>{% trans 'ID' %}</th>
                      <th>{% trans 'Created At' %}</th>
                      <th>{% trans 'Amount' %}</th>
                      <th>{% trans 'Payment Link' %}</th>
                      <th>{% trans 'Paid' %}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for payment_link in payment_link_list %}
                      <tr data-href="#"
                          data-id="{{ payment_link.id }}"
                          data-created_at="{{ payment_link.created_at }}"
                          data-amount="{{payment_link.amount}}"
                          data-link="{{ payment_link.link }}"
                          data-status="{{ payment_link.paid }}"
                          class="row-hover">
                        <td>{{ payment_link.id }}</td>
                        <td>{{ payment_link.created_at }}</td>
                        <td>{{ payment_link.amount }}</td>
                        <td><a class="previewBtn" href="{{payment_link.link}}" target="_blank"><i class=" fa fa-share-square-o"></i>Preview</a></td>                        
                        <td>
                          <div class="row {% if payment_link.paid  == True %}
                                     successful
                                  {% else %}
                                     failed
                                  {% endif %}"
                                style="text-align: center;"
                          >
                          
                          {{ payment_link.paid }}
                          </div>
                        </td>

                      </tr>
                    {% endfor %}
                  </tbody>
              </table>

              <ul class="pagination">
                {% if payment_link_list.has_previous %}
                  <li>
                    <a href="?{{query_string}}&page={{ payment_link_list.previous_page_number }}">
                      <i class="fa fa-chevron-left" aria-hidden="true"></i>
                    </a>
                  </li>
                {% else %}
                  <li class="disabled"><span><i class="fa fa-chevron-left" aria-hidden="true"></i></span></li>
                {% endif %}

                {% if payment_link_list.number|add:'-4' > 1 %}
                  <li><a href="?{{query_string}}&page={{ payment_link_list.number|add:'-5' }}">&hellip;</a></li>
                {% endif %}

                {% for i in payment_link_list.paginator.page_range %}
                  {% if payment_link_list.number == i %}
                    <li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
                  {% elif i > payment_link_list.number|add:'-5' and i < payment_link_list.number|add:'5' %}
                    <li><a href="?{{query_string}}&page={{ i }}">{{ i }}</a></li>
                  {% endif %}
                {% endfor %}

                {% if payment_link_list.paginator.num_pages > payment_link_list.number|add:'4' %}
                  <li><a href="?{{query_string}}&page={{ payment_link_list.number|add:'5' }}">&hellip;</a></li>
                {% endif %}

                {% if payment_link_list.has_next %}
                  <li><a href="?{{query_string}}&page={{ payment_link_list.next_page_number }}">
                    <i class="fa fa-chevron-right" aria-hidden="true"></i></a>
                  </li>
                {% else %}
                  <li class="disabled"><span><i class="fa fa-chevron-right" aria-hidden="true"></i></span></li>
                {% endif %}
              </ul>

              {% include 'pagination.html' %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {# End of page content #}

  {# Add new payment link modal #}
  <div class="modal fade" id="paymentlinkmodal" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4><span class="glyphicon glyphicon-plus"></span> {% trans 'Make New Payment Link' %}</h4>
        </div>
        <div class="modal-body">
          <div class="waiting-form-respond">
          </div>
          <form action="{% url 'disbursement:create_payment_link' %}"
                method="post" id="addTransactionForm" class="autoValidateForm" role="form">
            {% csrf_token %}
            <div class="row">
              <div class="form-group col-md-6 col-sm-6 col-xs-12">
                <label>
                  <span class="glyphicon glyphicon-tag"></span> {% trans 'Amount' %} *
                </label>
                {{form.amount}}
                <span class="respond-span"></span>
                <div class="help-block">
                  {{form.amount.errors}}
                </div>
              </div>
            </div>
            <!-- pin row -->
            <div class="row" id="pin_row">
              <div class="form-group col-md-12 col-sm-12 col-xs-12">
                {% if not request.user.from_accept or request.user.allowed_to_be_bulk %}
                  <label>
                    <span class="glyphicon glyphicon-pushpin"></span> {% trans 'Pin' %} *
                  </label>
                  {{form.pin}}
                  <span class="respond-span"></span>
                  <div class="help-block">
                    {{form.pin.errors}}
                  </div>
                {% endif %}
              </div>
            </div>

            <button id="submitModal" class="btn btn-primary pull-{{'right'|invert_dir:LANGUAGE_CODE}}" type="submit">{% trans 'Submit' %}</button>
            <button class="btn btn-default pull-{{'right'|invert_dir:LANGUAGE_CODE}}" data-dismiss="modal">{% trans 'Cancel' %}</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {# End of add new payment link modal #}

  {# Add new new payment link success modal #}
  <div class="modal fade" id="successModal" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">{% trans 'Success' %}</h4>
        </div>
        <div class="modal-body">
          <div class="alert alert-success" role="alert" id="status_description_success">
            {{ status_description }}
          </div>
          <div style="text-align: center;">
            <img src="{% static 'img/success.png' %}" style='margin:auto;' width = '30%'/>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">{% trans 'Close' %}</button>
        </div>
      </div>
    </div>
  </div>
  {# End of add new payment link success modal #}

  {# Add new payment link failed modal #}
  <div class="modal fade" id="failedModal" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">{% trans 'Failed' %}</h4>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger" role="alert" id="status_description_failed">
            {{ status_description }}
          </div>
          <div style="text-align: center;">
            <img src="{% static 'img/failed.png' %}"  width='30%'/>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">{% trans 'Close' %}</button>
        </div>
      </div>
    </div>
  </div>
  {# End of add new payment link failed modal #}

  {# Selected payment link details #}
  <div id="trxDetails" style="display: none;" class="row">
    <div class="col-md-12 col-sm-12 col-xs-12">
      <div class="x_panel">
        <div class="x_title">
          <h2 class="font-13 m-b-30" style="font-weight: bolder;">{% trans 'Payment Link Details' %}</h2>
            <button id="generate-pdf" class="btn btn-default export-dropdown
                            pull-{{'right'|invert_dir:LANGUAGE_CODE}}">
              <i class="fa fa-file-pdf-o"></i> {% trans 'Export PDF Report' %}
            </button>
          <div class="clearfix"></div>
        </div>

        <div class="x_content">
          <div class="row">
            <div class="col-md-6 col-sm-6 col-xs-6">
              <ul id="trxDetailsData">
              </ul>
            </div>
            <div class="col-md-6 col-sm-6 col-xs-6">
              <ul id="trxDetailsDataRight">
              </ul>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
              <ul id="trxDetailsDataLast">
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {# End of selected payment link details #}
{% endblock %}

{% block script %}
{# Datatables #}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="{% static 'gentella/vendors/datatables.net/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons/js/buttons.flash.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons/js/buttons.html5.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons/js/buttons.print.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-keytable/js/dataTables.keyTable.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-scroller/js/dataTables.scroller.min.js' %}"></script>
<script>

  var table = $('#transaction-table').DataTable({
    "bLengthChange" : false,
    "bPaginate": false,
    "bInfo" : false,
    "ordering": false
  });

  var buttons = new $.fn.dataTable.Buttons( table, {
        buttons: [
          {
                extend: 'copy',
                text : "{% trans 'Copy' %}",
                exportOptions: {
                    charSet: "utf-8",
                }
            },
            {
                extend: 'print',
                text : "PDF",
            },
            {
                extend: 'excelHtml5',
                text : "{% trans 'Export' %}",

                customize: function( xlsx ) {

                  var sheet = xlsx.xl.worksheets['sheet1.xml'];
                  $('row c[r^="A"]', sheet).attr( 's', '0' );
				       }
            }
        ]
    });

  table.buttons( 0, null ).container().prependTo(
        table.table().container()
    );
  let empty_row = $('.dataTables_empty');
  if (empty_row) {
    empty_row.parent().attr('id', 'empty_row');
  }

</script>
<!--  generate pdf script-->
<script src="{% static 'js/html2pdf.bundle.min.js' %}"></script>
<script>
  {% if show_add_form == True %}
    $("#paymentlinkmodal").modal();
  {% endif %}

  $("#addpaymentlink").click(function () {
      $("#paymentlinkmodal").modal();
  });

  {% if show_pop_up == True %}
    {% if status_code != "8000" and status_code != "200" and status_code != "8333" %}
      $('#failedModal').modal({
        backdrop: 'static',
        keyboard: false
      });
    {% else %}
      $('#successModal').modal({
        backdrop: 'static',
        keyboard: false
      });
    {% endif %}
  {% endif %}
  {% if request.GET.status%}
    {% if request.GET.status == '8000' or request.GET.status == '200' or request.GET.status == '8333' %}
      $("#status_description_success").html('{{request.GET.message}}');
      $('#successModal').modal({
            backdrop: 'static',
            keyboard: false
          });
    {% else %}
      $("#status_description_failed").html('{{request.GET.message}}');
        $('#failedModal').modal({
              backdrop: 'static',
              keyboard: false
            });
    {% endif %}
  {% endif %}
</script>

<!-- payment link details script  -->
<script>
  let trx = {};
  $('#transaction-table tbody').on('click', 'tr:not(#empty_row)', function () {
    if ($(this).hasClass('selected')) {
      $(this).removeClass('selected');
      $("#trxDetails").slideUp().fadeOut();
    }
    else {
      $('tr.selected').removeClass('selected');
      $(this).addClass('selected');
      let ul = $('#trxDetailsData');
      let ulRight = $('#trxDetailsDataRight');
      let ulLast = $('#trxDetailsDataLast');
      let appendedTags = '';
      let appendedTagsRight = '';
      let appendedTagsBottom = '';

    trx.id = $(this).data('id')
    appendedTags += `<li><span>{% trans 'Payment Link ID' %}</span><strong>: </strong>${trx.id}</li>`;
    trx.created_at = $(this).data('created_at');
    appendedTags += `<li><span>{% trans 'Created At' %}</span><strong>: </strong>${trx.created_at}</li>`;

    trx.status = $(this).data('status');
    appendedTagsRight += `<li><span>{% trans 'Paid' %}</span><strong>: </strong>${trx.status}</li>`;
    trx.amount= $(this).data('amount');
    appendedTagsRight += `<li><span>{% trans 'Amount' %}</span><strong>: </strong>${trx.amount}</li>`;
    trx.link = $(this).data('link');
    appendedTagsBottom += `<li><span>{% trans 'Payment Link' %}</span><strong>: </strong>${trx.link}</li>`;

      ul.empty();
      ul.append(appendedTags);
      ulRight.empty();
      ulRight.append(appendedTagsRight);
      ulLast.empty();
      ulLast.append(appendedTagsBottom);

      $("#trxDetails").slideDown();
      $('html,body').animate({
          scrollTop: $("#trxDetails").offset().top
      }, 'slow');
   }
  });
</script>

<!-- generate pdf script-->
<!-- Important Not this script should be after payment details script because   -->
<!-- because it uses trx object that exist in  payment details script above -->
{% include 'disbursement/transaction_details_pdf_js.html' %}



{% endblock %}



<td><a class="previewBtn" href="https://accept.paymobsolutions.com/standalone?ref=p_5qd" target="_blank"><i class=" fa fa-share-square-o"></i>Preview</a><button class="copyBtn"><i class="fa fa-clone"></i></button></td>