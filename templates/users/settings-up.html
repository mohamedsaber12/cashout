{% extends 'new_base.html' %}
{% load static %}
{% load i18n %}
{% load l10n %}
{% block gentellacss %}
    <link rel="stylesheet" href="{% static 'gentella/iCheck/skins/flat/green.css'%}">
    <link rel="stylesheet" href="{% static 'gentella/switchery.min.css'%}">
    <style>
        .error_span{
            color: red;
        }
    </style>
{% endblock %}
{% block title %}{% trans 'Settings' %}{% endblock %}
{% block body %}
        <form action="" method="post">
    </form>

    <p>{% trans 'Please follow the steps to setup your payroll settings.' %}</p>
    <div id="disb_widget" class="form_wizard wizard_horizontal">
      <ul class="wizard_steps">
        <li>
          <a href="#step-1">
            <span class="step_no">{{1|localize}}</span>
            <span class="step_descr">
                              {% trans 'Levels' %}<br />
                              <small>{% trans 'Add levels for checkers' %}</small>
                          </span>
          </a>
        </li>
        <li>
          <a href="#step-2">
            <span class="step_no">{{2|localize}}</span>
            <span class="step_descr">
                              {% trans 'Makers' %}<br />
                              <small>{% trans 'Add Maker users' %}</small>
                          </span>
          </a>
        </li>
        <li>
          <a href="#step-3">
            <span class="step_no">{{3|localize}}</span>
            <span class="step_descr">
              {% trans 'Checkers' %}<br />
              <small>{% trans 'Add Checker users' %}</small>
          </span>
          </a>
        </li>
        <li>
          <a href="#step-4">
            <span class="step_no">{{4|localize}}</span>
            <span class="step_descr">
              {% trans 'Category' %}<br />
              <small>{% trans 'Add File Specs' %}</small>
          </span>
          </a>
        </li>
        <li>
            <a href="#step-5">
                <span class="step_no">{{5|localize}}</span>
                <span class="step_descr">
                    {% trans 'Format' %}<br />
                    <small>{% trans 'Add File Formats' %}</small>
                </span>
            </a>
        </li>
        {% if perms.users.has_collection %}
            <li>
                <a href="#step-6">
                    <span class="step_no">{{6|localize}}</span>
                    <span class="step_descr">
                        {% trans 'Collection' %}<br />
                        <small>{% trans 'Add Collection Data' %}</small>
                    </span>
                </a>
            </li>
        {%endif%}
      </ul>

    <span id='non_form_errors' class="error_span"></span>
      <div id="step-1">
        
        

            <form action="." method="post" id="step_1_form">
            
                {% csrf_token %}
            
                <table class="table" id="levelform">
                    {{ levelform.management_form }}
                    {% for form in levelform.forms %}
                    {% if forloop.first %}
                    <thead>
                        <tr>
                            {% for field in form.visible_fields %}
                            <th>{{ field.label|capfirst }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
            
                    {% endif %}
                    {% endfor %}
                    <tbody>
            
                        {% for form in levelform.forms %}
            
                        <tr class="level_formset_row">
                            {% for field in form.visible_fields %}
                                <td id="level_{{field.name}}">
                                    {# Include the hidden fields in the form #}
                                    {% if forloop.first %}
                                    {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                    {% endfor %}
                                    {% endif %}
                                    {{ field.errors.as_ul }}
                                    {{ field }}
                                    <span class="error_span"></span>
                                </td>
                                    {% endfor %}                        
                        </tr>
                             
                        {% endfor %}

                        
                    </tbody>
                </table>
            
            </form>
            
<!-- empty form -->

<table id="level_empty_form" style="display: none">
<tr class="level_formset_row"  >
    {% for field in levelform.empty_form.visible_fields %}
    <td id="level_{{field.name}}">
        {# Include the hidden fields in the form #}
        {% if forloop.first %}
        {% for hidden in levelform.empty_form.hidden_fields %}
        {{ hidden }}
        {% endfor %}
        {% endif %}
        {{ field.errors.as_ul }}
        {{ field }}
        <span class="error_span"></span>
    </td>
    {% endfor %}
</tr>
</table>
    

            <button id="add_level_btn" class="btn btn-success">{% trans 'Add another level' %}</button>

      </div>
      <div id="step-2">
        
        <form action="." method="post" id="step_2_form">

          {% csrf_token %}

        <table class="table" id="makerform">
            {{ makerform.management_form }}
            {% for form in makerform.forms %}
                {% if forloop.first %}
                <thead>
                    <tr>
                        {% for field in form.visible_fields %}
                            <th>{{ field.label|capfirst }}</th>
                        {% endfor %}
                    </tr>
                </thead>

                {% endif %}
            {% endfor %}
            <tbody>

            {% for form in makerform.forms %}

                <tr class="maker_formset_row" >
                    {% for field in form.visible_fields %}
                        <td id="maker_{{field.name}}">
                            {# Include the hidden fields in the form #}
                            {% if forloop.first %}
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                            {% endif %}
                            {{ field.errors.as_ul }}
                            {{ field }}
                            <span class="error_span"></span>
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
                </tbody>
        </table>

        </form>

<!-- empty form -->

<table id="maker_empty_form" style="display: none">
    <tr class="maker_formset_row">
        {% for field in makerform.empty_form.visible_fields %}
        <td id="maker_{{field.name}}"> 
            {# Include the hidden fields in the form #}
            {% if forloop.first %}
            {% for hidden in makerform.empty_form.hidden_fields %}
            {{ hidden }}
            {% endfor %}
            {% endif %}
            {{ field.errors.as_ul }}
            {{ field }}
            <span class="error_span"></span>
        </td>
        {% endfor %}
    </tr>
</table>
<button id="add_maker_btn" class="btn btn-success">{% trans 'Add family member' %}</button>
      </div>
      <div id="step-3">
        
        <form action="." method="post" id="step_3_form">

          {% csrf_token %}

        <table class="table" id="checkerform">
            {{ checkerform.management_form }}
            {% for form in checkerform.forms %}
                {% if forloop.first %}
                <thead>
                    <tr>
                        {% for field in form.visible_fields %}
                            <th>{{ field.label|capfirst }}</th>
                        {% endfor %}
                    </tr>
                </thead>

                {% endif %}
            {% endfor %}
            <tbody>

            {% for form in checkerform.forms %}

                <tr class="checker_formset_row">
                    {% for field in form.visible_fields %}
                        <td id="checker_{{field.name}}">
                            {# Include the hidden fields in the form #}
                            {% if forloop.first %}
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                            {% endif %}
                            {{ field.errors.as_ul }}
                            {{ field }}
                            <span class="error_span"></span>
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
                </tbody>
        </table>

        </form>

<!-- empty form -->

<table id="checker_empty_form" style="display: none">
    <tr class="checker_formset_row">
        {% for field in checkerform.empty_form.visible_fields %}
        <td id="checker_{{field.name}}">
            {# Include the hidden fields in the form #}
            {% if forloop.first %}
            {% for hidden in checkerform.empty_form.hidden_fields %}
            {{ hidden }}
            {% endfor %}
            {% endif %}
            {{ field.errors.as_ul }}
            {{ field }}
            <span class="error_span"></span>
        </td>
        {% endfor %}
    </tr>
</table>
<button id="add_checker_btn" class="btn btn-success">{% trans 'Add family member' %}</button>
      </div>
       
      
      <div id="step-4">
            <form action="." method="post" id="step_4_form" class="form-horizontal form-label-left">

                {% csrf_token %}

                            {% for field in filecategoryform.visible_fields %}
                                {% if forloop.first %}
                                    {% for hidden in form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                {% endif %}
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12">{{ field.label|capfirst }}</label>
                                    <div class="col-md-6 col-sm-9 col-xs-12">
                                        {% ifequal field.name "has_header" %}
                                            <div class="">
                                            <label>
                                                {{ field }}
                                            </label>
                                            </div>
                                        {% else %}
                                            {{ field.errors.as_ul }}
                                            {{ field }}
                                        {% endifequal %}
                                        <span id="category_error_{{field.name}}" class="error_span"></span>
                                    </div>
                                </div>


                        {% endfor %}
            </form>
        </div>
    
       
        <!-- step-5 --> 
        <div id="step-5" style="overflow-x: scroll;">
        
            <form action="." method="post" id="step_5_form">
        
                {% csrf_token %}
        
                <table class="table" id="formatform">
                    {{ formatform.management_form }}
                    {% for form in formatform.forms %}
                    {% if forloop.first %}
                    <thead>
                        <tr>
                            {% for field in form.visible_fields %}
                            <th>{{ field.label|capfirst }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
        
                    {% endif %}
                    {% endfor %}
                    <tbody>
        
                        {% for form in formatform.forms %}
        
                        <tr class="format_formset_row">
                            {% for field in form.visible_fields %}
                            <td id="format_{{field.name}}">
                                {# Include the hidden fields in the form #}
                                {% if forloop.first %}
                                {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                                {% endfor %}
                                {% endif %}
                                {{ field.errors.as_ul }}
                                {{ field }}
                                <span class="error_span"></span>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
        
            </form>
        
            <!-- empty form -->
        
            <table id="format_empty_form" style="display: none">
                <tr class="format_formset_row">
                    {% for field in formatform.empty_form.visible_fields %}
                    <td id="format_{{field.name}}">
                        {# Include the hidden fields in the form #}
                        {% if forloop.first %}
                        {% for hidden in formatform.empty_form.hidden_fields %}
                        {{ hidden }}
                        {% endfor %}
                        {% endif %}
                        {{ field.errors.as_ul }}
                        {{ field }}
                        <span class="error_span"></span>
                    </td>
                    {% endfor %}
                </tr>
            </table>
            <button id="add_format_btn" class="btn btn-success">{% trans 'Add format' %}</button>
        </div>
        <!-- step-5 -->

        <!-- step-6 -->
        <div id="step-6">
            <form action="." method="post" id="step_6_form" class="form-horizontal form-label-left">
        
                {% csrf_token %}
        
                {% for field in collectiondataform.visible_fields %}
                {% if forloop.first %}
                {% for hidden in form.hidden_fields %}
                {{ hidden }}
                {% endfor %}
                {% endif %}
                <div class="form-group">
                    <label class="control-label col-md-3 col-sm-3 col-xs-12">{{ field.label|capfirst }}</label>
                    <div class="col-md-6 col-sm-9 col-xs-12">
                        {% ifequal field.name "has_header" %}
                        <div class="">
                            <label>
                                {{ field }}
                            </label>
                        </div>
                        {% else %}
                        {{ field.errors.as_ul }}
                        {{ field }}
                        {% endifequal %}
                        <span id="collection_data_error_{{field.name}}" class="error_span"></span>
                    </div>
                </div>
        
        
                {% endfor %}
            </form>
        </div>
        <!-- step-6 -->

    </div>

{% endblock %}

{% block script %}
<script src="{% static 'gentella/jquery.smartWizard.js' %}"></script>
<script src="{% static 'gentella/switchery.min.js' %}"></script>
<script type="text/javascript">

    $(document).ready(function () {
        let form_idx = $('#id_level-TOTAL_FORMS').val();
        if (form_idx === '4') {
            $('#add_level_btn').hide()
        }
        let final_step;
        if ($('#step-6').length)
            final_step = 6;
        else
            final_step = 5;
        
        let step = parseInt('{{step}}');
        var wizard = $('#disb_widget').smartWizard({
            selected: step,
            labelNext:' {% trans "Next" %} ',
            labelPrevious: ' {% trans "Previous" %} ',
            labelFinish: ' {% trans "Finish" %} ',
            onLeaveStep:leaveAStepCallback,
            onFinish: onFinishCallback

        });
        if(step>0){
            let step_real = step+1
            $('#disb_widget').smartWizard('enableStep', step_real-1);
            if(step_real-1 !== 0)
                $('#disb_widget').smartWizard('enableStep', step_real - 2);
        }   
        $('#loading-image').bind('ajaxStart', function(){
            $(this).show();
        }).bind('ajaxStop', function(){
            $(this).hide();
        });
        var oldheight = $('.stepContainer').css('height');
        oldheight = parseInt(oldheight.replace("px", ""));
        var newheight = oldheight+20;
        $('.stepContainer').height(newheight+"px");

        function onFinishCallback(objs, context){
            return stepSubmit(final_step);    
        }

        function leaveAStepCallback(obj, context){
            if(context.fromStep > context.toStep){
                window.location.href =  "{% url 'users:settings' %}" + '?step=' + String(context.toStep-1)
            
            }
            else    
                return stepSubmit(context.fromStep);
                // return false to stay on step and true to continue navigation
        }


        function increase_height() {
            let oldheight = $('.stepContainer').css('height');
            oldheight = parseInt(oldheight.replace("px", ""));
            let newheight = oldheight + 50;
            $('.stepContainer').height(newheight + "px");
        }

        $('#add_level_btn').click(function () {
            let form_idx = $('#id_level-TOTAL_FORMS').val();
            if (form_idx === '3') {
                $(this).hide()
            }

            $('#step-1 #levelform tbody').append($('#level_empty_form tbody').html().replace(/__prefix__/g, form_idx));
            $('#id_level-TOTAL_FORMS').val(parseInt(form_idx) + 1);

            increase_height()


        });

        $('#add_maker_btn').click(function () {
            let form_idx = $('#id_maker-TOTAL_FORMS').val();

            $('#step-2 #makerform tbody').append($('#maker_empty_form tbody').html().replace(/__prefix__/g, form_idx));
            $('#id_maker-TOTAL_FORMS').val(parseInt(form_idx) + 1);

            increase_height()

        });

        $('#add_checker_btn').click(function () {

            let form_idx = $('#id_checker-TOTAL_FORMS').val();

            $('#step-3 #checkerform tbody').append($('#checker_empty_form tbody').html().replace(/__prefix__/g, form_idx));
            $('#id_checker-TOTAL_FORMS').val(parseInt(form_idx) + 1);

            increase_height()
        });

        $('#add_format_btn').click(function () {
            let form_idx = $('#id_format-TOTAL_FORMS').val();

            $('#step-5 #formatform tbody').append($('#format_empty_form tbody').html().replace(/__prefix__/g, form_idx));
            $('#id_format-TOTAL_FORMS').val(parseInt(form_idx) + 1);

            increase_height()

        });

        function stepSubmit(step_no) {
            
            var bool_return = false;
            let step_no_string = String(step_no)

            var form_data = $("#step_" + step_no_string + "_form").serialize();


            $.ajax({
                type: 'post',
                url: "{% url 'users:settings' %}",
                async: false,
                data: form_data + "&step=" + step_no_string,
                success: function (data, text, xhr) {
                    
                    $('.error_span').html('');

                    if (xhr.status == 278 && step_no == final_step) {
                        window.location.href = xhr.getResponseHeader("Location");
                    }
                    
                    if (!data.valid && !data.form_is_formset) {
                        for (let field_name in data.errors) {
                            let err_value = data.errors[field_name][0]
                            $('#' + data.prefix + '_error_' + field_name).html(err_value)

                        }
                    }
                    else if (!data.valid && data.form_is_formset) {

                        if (data.non_form_errors && data.non_form_errors[0]) {
                            $('#non_form_errors').html(data.non_form_errors[0])
                        }

                        let prefix = data.prefix
                        let rows = $('#' + prefix + 'form' + ' .' + prefix + '_formset_row');
                        for (let i in data.errors) {
                            for (let field_name in data.errors[i]) {
                                let err_value = data.errors[i][field_name][0]
                                $(rows[i]).find('#' + prefix + '_' + field_name + ' span').html(err_value)
                            }
                        }

                    }

                    bool_return = data.valid;
                    
                    // refresh before step 3 (checkers) to get new levels
                    if (step_no==2 && bool_return){
                        window.location.href =  "{% url 'users:settings' %}" + '?step=' + String(step_no)
                    }
                    return true;
                }

            });
            return bool_return;
        }

    });

</script>
{% endblock %}