{% extends 'new_base.html' %}
{% load static %}
{% load i18n %}
{% load l10n %}
{% block gentellacss %}
    <link rel="stylesheet" href="{% static 'gentella/iCheck/skins/flat/green.css'%}">
    <link rel="stylesheet" href="{% static 'gentella/switchery.min.css'%}">
    <style>
        .error_span{
            color: red;
        }
    </style>
{% endblock %}
{% block title %}{% trans 'Settings' %}{% endblock %}
{% block body %}
        <form action="" method="post">
    </form>

    <p>{% trans 'Please follow the steps to setup your payroll settings.' %}</p>
    <div id="disb_widget" class="form_wizard wizard_horizontal">
      <ul class="wizard_steps">

        <li>
            <a href="#step-1">
                <span class="step_no">{{1|localize}}</span>
                <span class="step_descr">
                    {% trans 'Add Pin' %}<br />
                    <small>{% trans 'Add Pin' %}</small>
                </span>
            </a>
        </li>

        <li>
          <a href="#step-2">
            <span class="step_no">{{2|localize}}</span>
            <span class="step_descr">
                              {% trans 'Makers' %}<br />
                              <small>{% trans 'Add Maker users' %}</small>
                          </span>
          </a>
        </li>



        <li>
            <a href="#step-3">
                <span class="step_no">{{3|localize}}</span>
                <span class="step_descr">
                    {% trans 'Levels' %}<br />
                    <small>{% trans 'Add levels for checkers' %}</small>
                </span>
            </a>
        </li>

        <li>
          <a href="#step-4">
            <span class="step_no">{{4|localize}}</span>
            <span class="step_descr">
              {% trans 'Checkers' %}<br />
              <small>{% trans 'Add Checker users' %}</small>
          </span>
          </a>
        </li>

        <li>
            <a href="#step-5">
                <span class="step_no">{{5|localize}}</span>
                <span class="step_descr">
                    {% trans 'Format' %}<br />
                    <small>{% trans 'Add File Formats' %}</small>
                </span>
            </a>
        </li>

      </ul>

    <span id='non_form_errors' class="error_span"></span>
        {% include "users/setting_up_pin_form.html" with step=1  pinform=pinform %}
        <div id="step-2" form_prefix="maker">

        <form action="." method="post" id="step_2_form">

            {% csrf_token %}

        <table class="table" id="makerform">
            {{ makerform.management_form }}
            {% for form in makerform.forms %}
                {% if forloop.first %}
                <thead>
                    <tr>
                        {% for field in form.visible_fields %}
                            <th>{{ field.label|capfirst }}</th>
                        {% endfor %}
                    </tr>
                </thead>

                {% endif %}
            {% endfor %}
            <tbody>

            {% for form in makerform.forms %}

                <tr class="maker_formset_row" >
                    {% for field in form.visible_fields %}
                        <td id="maker_{{field.name}}">
                            {# Include the hidden fields in the form #}
                            {% if forloop.first %}
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                            {% endif %}
                            {{ field.errors.as_ul }}
                            {{ field }}
                            <span class="error_span"></span>
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
                </tbody>
        </table>

        </form>

        <!-- empty form -->

        <table id="maker_empty_form" style="display: none">
        <tr class="maker_formset_row">
        {% for field in makerform.empty_form.visible_fields %}
        <td id="maker_{{field.name}}"> 
            {# Include the hidden fields in the form #}
            {% if forloop.first %}
            {% for hidden in makerform.empty_form.hidden_fields %}
            {{ hidden }}
            {% endfor %}
            {% endif %}
            {{ field.errors.as_ul }}
            {{ field }}
            <span class="error_span"></span>
        </td>
        {% endfor %}
        </tr>
        </table>
        <button id="add_maker_btn" class="btn btn-success">{% trans 'Add family member' %}</button>
        </div>
        
        <div id="step-3" form_prefix="level">
        
        
        
            <form action="." method="post" id="step_3_form">
        
                {% csrf_token %}
        
                <table class="table" id="levelform">
                    {{ levelform.management_form }}
                    {% for form in levelform.forms %}
                    {% if forloop.first %}
                    <thead>
                        <tr>
                            {% for field in form.visible_fields %}
                            <th>{{ field.label|capfirst }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
        
                    {% endif %}
                    {% endfor %}
                    <tbody>
        
                        {% for form in levelform.forms %}
        
                        <tr class="level_formset_row">
                            {% for field in form.visible_fields %}
                            <td id="level_{{field.name}}">
                                {# Include the hidden fields in the form #}
                                {% if forloop.first %}
                                {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                                {% endfor %}
                                {% endif %}
                                {{ field.errors.as_ul }}
                                {{ field }}
                                <span class="error_span"></span>
                            </td>
                            {% endfor %}
                        </tr>
        
                        {% endfor %}
        
        
                    </tbody>
                </table>
        
            </form>
        
            <!-- empty form -->
        
            <table id="level_empty_form" style="display: none">
                <tr class="level_formset_row">
                    {% for field in levelform.empty_form.visible_fields %}
                    <td id="level_{{field.name}}">
                        {# Include the hidden fields in the form #}
                        {% if forloop.first %}
                        {% for hidden in levelform.empty_form.hidden_fields %}
                        {{ hidden }}
                        {% endfor %}
                        {% endif %}
                        {{ field.errors.as_ul }}
                        {{ field }}
                        <span class="error_span"></span>
                    </td>
                    {% endfor %}
                </tr>
            </table>
        
        
            <button id="add_level_btn" class="btn btn-success">{% trans 'Add another level' %}</button>
        
        </div>
        <div id="step-4" form_prefix="checker">
        
            <form action="." method="post" id="step_4_form">
        
                {% csrf_token %}
        
                <table class="table" id="checkerform">
                    {{ checkerform.management_form }}
                    {% for form in checkerform.forms %}
                    {% if forloop.first %}
                    <thead>
                        <tr>
                            {% for field in form.visible_fields %}
                            <th>{{ field.label|capfirst }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
        
                    {% endif %}
                    {% endfor %}
                    <tbody>
        
                        {% for form in checkerform.forms %}
        
                        <tr class="checker_formset_row">
                            {% for field in form.visible_fields %}
                            <td id="checker_{{field.name}}">
                                {# Include the hidden fields in the form #}
                                {% if forloop.first %}
                                {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                                {% endfor %}
                                {% endif %}
                                {{ field.errors.as_ul }}
                                {{ field }}
                                <span class="error_span"></span>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
        
            </form>
        
            <!-- empty form -->
        
            <table id="checker_empty_form" style="display: none">
                <tr class="checker_formset_row">
                    {% for field in checkerform.empty_form.visible_fields %}
                    <td id="checker_{{field.name}}">
                        {# Include the hidden fields in the form #}
                        {% if forloop.first %}
                        {% for hidden in checkerform.empty_form.hidden_fields %}
                        {{ hidden }}
                        {% endfor %}
                        {% endif %}
                        {{ field.errors.as_ul }}
                        {{ field }}
                        <span class="error_span"></span>
                    </td>
                    {% endfor %}
                </tr>
            </table>
            <button id="add_checker_btn" class="btn btn-success">{% trans 'Add family member' %}</button>
        </div>

        {% include "users/settings_up_category_form.html" with step=5  filecategoryform=filecategoryform %}

    
    </div>

{% endblock %}

{% block script %}
<script src="{% static 'gentella/jquery.smartWizard.js' %}"></script>
<script src="{% static 'gentella/switchery.min.js' %}"></script>
<script type="text/javascript">

    $(document).ready(function () {
        let form_idx = $('#id_level-TOTAL_FORMS').val();
        if (form_idx === '4') {
            $('#add_level_btn').hide()
        }
        let final_step = 5;
        
        let step = parseInt('{{step}}');
        var wizard = $('#disb_widget').smartWizard({
            selected: step,
            labelNext:' {% trans "Next" %} ',
            labelPrevious: ' {% trans "Previous" %} ',
            labelFinish: ' {% trans "Finish" %} ',
            onLeaveStep:leaveAStepCallback,
            onFinish: onFinishCallback

        });
        if(step>0){
            for (let index = 0; index <= step; index++) {
                $('#disb_widget').smartWizard('enableStep', index);   
            }
        }   
        $('#loading-image').bind('ajaxStart', function(){
            $(this).show();
        }).bind('ajaxStop', function(){
            $(this).hide();
        });
        var oldheight = $('.stepContainer').css('height');
        oldheight = parseInt(oldheight.replace("px", ""));
        var newheight = oldheight+20;
        $('.stepContainer').height(newheight+"px");

        function onFinishCallback(objs, context){
            return stepSubmit(final_step);    
        }

        function leaveAStepCallback(obj, context){
            if(context.fromStep > context.toStep){
                let form_prefix = $("#step-" + String(context.toStep)).attr('form_prefix');
                window.location.href =  "{% url 'users:settings-dibursement' %}" + '?step=' + 
                String(context.toStep-1) + "&prefix=" + form_prefix
            
            }
            else    
                return stepSubmit(context.fromStep);
                // return false to stay on step and true to continue navigation
        }


        function increase_height() {
            let oldheight = $('.stepContainer').css('height');
            oldheight = parseInt(oldheight.replace("px", ""));
            let newheight = oldheight + 50;
            $('.stepContainer').height(newheight + "px");
        }

        $('#add_level_btn').click(function () {
            let form_idx = $('#id_level-TOTAL_FORMS').val();
            if (form_idx === '3') {
                $(this).hide()
            }

            $('#step-3 #levelform tbody').append($('#level_empty_form tbody').html().replace(/__prefix__/g, form_idx));
            $('#id_level-TOTAL_FORMS').val(parseInt(form_idx) + 1);

            increase_height()


        });

        $('#add_maker_btn').click(function () {
            let form_idx = $('#id_maker-TOTAL_FORMS').val();

            $('#step-2 #makerform tbody').append($('#maker_empty_form tbody').html().replace(/__prefix__/g, form_idx));
            $('#id_maker-TOTAL_FORMS').val(parseInt(form_idx) + 1);

            increase_height()

        });

        $('#add_checker_btn').click(function () {

            let form_idx = $('#id_checker-TOTAL_FORMS').val();

            $('#step-4 #checkerform tbody').append($('#checker_empty_form tbody').html().replace(/__prefix__/g, form_idx));
            $('#id_checker-TOTAL_FORMS').val(parseInt(form_idx) + 1);

            increase_height()
        });

        $('#add_category_btn').click(function () {
            let form_idx = $('#id_category-TOTAL_FORMS').val();

            $('#step-5 #categoryform tbody').append($('#category_empty_form tbody').html().replace(/__prefix__/g, form_idx));
            $('#id_category-TOTAL_FORMS').val(parseInt(form_idx) + 1);

            increase_height()

        });

        function stepSubmit(step_no) {
            
            let bool_return = false;
            let step_no_string = String(step_no)

            var form_data = $("#step_" + step_no_string + "_form").serialize();
            let form_prefix = $("#step-" + step_no_string).attr('form_prefix');

            $.ajax({
                type: 'post',
                url: "{% url 'users:settings-dibursement' %}",
                async: false,
                data: form_data + "&step=" + step_no_string + "&prefix=" + form_prefix,
                success: function (data, text, xhr) {
                    
                    $('.error_span').html('');

                    if (xhr.status == 278 && step_no == final_step) {
                        window.location.href = xhr.getResponseHeader("Location");
                    }
                    
                    if (!data.valid && !data.form_is_formset) {
                        for (let field_name in data.errors) {
                            let err_value = data.errors[field_name][0]
                            $('#' + data.prefix + '_error_' + field_name).html(err_value)

                        }
                    }
                    else if (!data.valid && data.form_is_formset) {

                        if (data.non_form_errors && data.non_form_errors[0]) {
                            $('#non_form_errors').html(data.non_form_errors[0])
                        }

                        let prefix = data.prefix
                        let rows = $('#' + prefix + 'form' + ' .' + prefix + '_formset_row');
                        for (let i in data.errors) {
                            for (let field_name in data.errors[i]) {
                                let err_value = data.errors[i][field_name][0]
                                $(rows[i]).find('#' + prefix + '_' + field_name + ' span').html(err_value)
                                if (field_name === '__all__'){
                                    $(rows[i]).find( '#' + prefix + '_row_' + i + '_error').html(err_value)
                                }
                            }
                        }

                    }
                    
                    // refresh before step 4 (checkers) to get new levels
                    if (step_no==3 && data.valid){
                        window.location.href =  "{% url 'users:settings-dibursement' %}" + '?step=' + String(step_no)
                        + "&prefix=checker"
                    }
                    
                    bool_return = data.valid
                }

            });
            return bool_return;
        }

    });

</script>
{% endblock %}