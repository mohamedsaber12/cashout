{% extends 'new_base.html' %}
{% load static %}
{% load i18n %}
{% load custom_tags %}
{% load transactions_tags i18n %}
{% block title %} Transactions {% endblock %}
{% block gentellacss %}
<!-- Datatables -->
<link href="{% static 'gentella/vendors/datatables.net-bs/css/dataTables.bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'gentella/vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'gentella/vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'gentella/vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'gentella/vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css' %}" rel="stylesheet">
<style>
    .row-hover:hover {
        background-color: transparent;
        cursor: pointer;
        color: #444;
        box-shadow: 0px 2px 2px #ccc, 0px -2px 2px #ccc;
        transform: translate(-1px,-1px);
    }
    .selected {
        background-color: #f0f0f0 !important;
        cursor: pointer;
        color: #333;
        box-shadow: 0px 2px 2px #ccc, 0px -2px 2px #ccc;
        transform: translateY(-1px);
    }
    ul{
        list-style: none;
        padding: 0px;
    }
    ul > li > span{
        display: inline-block;
        width: 210px;
        font-weight: bold;
        color: #73879C;
        line-height: 25px;
    }
    ul > li > b{
        margin-right: 5px;
        color: #777;
    }
</style>
{% endblock %}

{% block body %}


<div class="row">
    <div hidden id="all-alert-msg" class="alert alert-info col-md-6 pull-{{'left'|invert_dir:LANGUAGE_CODE}}">
        {% trans 'You will receive an email shortly with the file to download' %}
    </div>
    <!-- button -->
    <div class="col-md-6 pull-{{'right'|invert_dir:LANGUAGE_CODE}}">
        <button id="export-all"
            class="btn btn-success pull-{{'right'|invert_dir:LANGUAGE_CODE}}">{% trans 'Export All' %}
        </button>
    </div>
</div>
{% if has_failed %}
<div class="row">
    <div hidden id="failed-alert-msg" class="alert alert-info col-md-6 pull-{{'left'|invert_dir:LANGUAGE_CODE}}">
        {% trans 'You will receive an email shortly with the failed data file to download' %}
    </div>
    <!-- button -->
    <div class="col-md-6 pull-{{'right'|invert_dir:LANGUAGE_CODE}}">
        <button  id="export-failed" class="btn btn-success pull-{{'right'|invert_dir:LANGUAGE_CODE}}">{% trans 'Export Failed' %}
        </button>
    </div>
</div>
{%endif%}
{% if has_success %}
<div class="row">
    <div hidden id="success-alert-msg" class="alert alert-info col-md-6 pull-{{'left'|invert_dir:LANGUAGE_CODE}}">
        {% trans 'You will receive an email shortly with the success data file to download' %}
    </div>
    <!-- button -->
    <div class="col-md-6 pull-{{'right'|invert_dir:LANGUAGE_CODE}}">
        <button id="export-success"
            class="btn btn-success pull-{{'right'|invert_dir:LANGUAGE_CODE}}">{% trans 'Export Success' %}
        </button>
    </div>
</div>
{%endif%}

<div class="row">
    <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="x_panel">
            <div class="x_title">
                <h2>{% trans 'Transactions' %} <small>{% trans 'Document name:' %} <a target="_blank" href="{% url 'data:download_doc' doc_obj.id %}">{{doc_obj.filename}}</a></small></h2>
                <ul class="nav navbar-right panel_toolbox">
                    <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
                </ul>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <table class="table table-bordered" id="transaction-table">
                    {% if doc_obj.is_bank_wallet %}
                      <thead>
                        <tr>
                          <th>{% trans 'Transaction ID' %}</th>
                          <th>{% trans 'Wallet Number' %}</th>
                          <th>{% trans 'Amount' %}</th>
                          <th>{% trans 'Disbursed?' %}</th>
                          </tr>
                      </thead>
                      <tbody>
                        {% for transaction in doc_transactions %}
                          <tr data-id="{{ transaction.uid }}"
                              data-anon_recipient="{{ transaction.anon_recipient }}"
                              data-amount="{{ transaction.amount }}"
                              data-recipient_name="{{ transaction.recipient_name }}"
                              data-status="{{ transaction.status|status }}"
                              data-transaction_status_code="{{ transaction.transaction_status_code }}"
                              data-transaction_status_description="{{ transaction.transaction_status_description }}"
                              data-doc_maker="{{ doc_obj.owner }}"
                              data-doc_checker="{{ doc_obj.disbursed_by }}"
                              data-doc_id="{{ doc_obj.id }}"
                              class="row-hover">
                            <td>{{ transaction.uid }}</td>
                            <td>{{ transaction.anon_recipient }}</td>
                            <td>{{ transaction.amount }}</td>
                            <td>{{ transaction.status|status }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    {% else %}
                      <thead>
                        <tr>
                          <th>{% trans 'Transaction ID' %}</th>
                          <th>{% trans 'Account Number' %}</th>
                          <th>{% trans 'Amount' %}</th>
                          <th>{% trans 'Disbursed?' %}</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for transaction in doc_transactions %}
                          <tr data-id="{{ transaction.parent_transaction.transaction_id }}"
                              data-creditor_account_number="{{ transaction.creditor_account_number }}"
                              data-amount="{{ transaction.amount }}"
                              data-creditor_name="{{ transaction.creditor_name }}"
                              data-status="{{ transaction.status|status }}"
                              data-creditor_bank="{{ transaction.creditor_bank }}"
                              data-transaction_status_code="{{ transaction.transaction_status_code }}"
                              data-transaction_status_description="{{ transaction.transaction_status_description }}"
                              data-doc_maker="{{ doc_obj.owner }}"
                              data-doc_checker="{{ doc_obj.disbursed_by }}"
                              data-doc_id="{{ doc_obj.id }}"
                              class="row-hover">
                            <td>{{ transaction.parent_transaction.transaction_id }}</td>
                            <td>{{ transaction.creditor_account_number }}</td>
                            <td>{{ transaction.amount }}</td>
                            <td>{{ transaction.status|status }}</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
</div>

<!-- transaction details -->
  <div id="trxDetails" style="display: none;" class="row">
      <div class="col-md-12 col-sm-12 col-xs-12">
          <div class="x_panel">
              <div class="x_title">
                  <h2 class="font-13 m-b-30" style="font-weight: bolder;">{% trans 'Transaction Details' %}</h2>
                  <div class="clearfix"></div>
              </div>

              <div class="x_content">
                  <ul id="trxDetailsData">
                  </ul>
              </div>

          </div>
      </div>
  </div>
{% endblock %}

{% block script %}
<!-- Datatables -->
<script src="{% static 'gentella/vendors/datatables.net/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons/js/buttons.flash.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons/js/buttons.html5.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons/js/buttons.print.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-keytable/js/dataTables.keyTable.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-scroller/js/dataTables.scroller.min.js' %}"></script>
<script>
    $('#transaction-table').DataTable();

    $(document).ready(function () {

        $('#export-failed').on('click',function(ev) {
            $.ajax({
                type:'GET',
                url: '{{request.path}}' + '?export_failed=true',
                success: function (data, text, xhr) {
                    $('#failed-alert-msg').show()
                },
            })

        });
        $('#export-success').on('click', function (ev) {
            $.ajax({
                type: 'GET',
                url: '{{request.path}}' + '?export_success=true',
                success: function (data, text, xhr) {
                    $('#success-alert-msg').show()
                },
            })

        });
        $('#export-all').on('click', function (ev) {
            $.ajax({
                type: 'GET',
                url: '{{request.path}}' + '?export_all=true',
                success: function (data, text, xhr) {
                    $('#all-alert-msg').show()
                },
            })

        });
    });

</script>
 <script>
    $('#transaction-table tbody').on( 'click', 'tr', function () {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
            $("#trxDetails").hide();
        }
        else {
            $('tr.selected').removeClass('selected');
            $(this).addClass('selected');
            let ul = $('#trxDetailsData');
            let appendedTags = '';
            {% if doc_obj.is_bank_wallet %}
              let uid = $(this).data('id');
              appendedTags += `<li><span>Transaction ID</span><b>:</b>${uid}</li>`;
              let anon_recipient = $(this).data('anon_recipient');
              appendedTags += `<li><span>Wallet number</span><b>:</b>${anon_recipient}</li>`;
              let amount = $(this).data('amount');
              appendedTags += `<li><span>Amount</span><b>:</b>${amount}</li>`;
              let recipient_name = $(this).data('recipient_name');
              appendedTags += `<li><span>Full name</span><b>:</b>${recipient_name}</li>`;
              let status = $(this).data('status');
              appendedTags += `<li><span>Disbursed</span><b>:</b>${status}</li>`;
            {% else %}
              let uid = $(this).data('id');
              appendedTags += `<li><span>Transaction ID</span><b>:</b>${uid}</li>`;
              let creditor_account_number = $(this).data('creditor_account_number');
              appendedTags += `<li><span>Account number</span><b>:</b>${creditor_account_number}</li>`;
              let amount = $(this).data('amount');
              appendedTags += `<li><span>Amount</span><b>:</b>${amount}</li>`;
              let creditor_name = $(this).data('creditor_name');
              appendedTags += `<li><span>Full name</span><b>:</b>${creditor_name}</li>`;
              let creditor_bank = $(this).data('creditor_bank');
              appendedTags += `<li><span>Bank code</span><b>:</b>${creditor_bank}</li>`;
              // will add bank name
              appendedTags += `<li><span>Bank name</span><b>:</b></li>`;
              // will add transaction type
              appendedTags += `<li><span>Transaction Type</span><b>:</b></li>`;
              let status = $(this).data('status');
              appendedTags += `<li><span>Disbursed</span><b>:</b>${status}</li>`;
            {% endif %}
            let transaction_status_code = $(this).data('transaction_status_code');
              appendedTags += `<li><span>Disbursement Status Code</span><b>:</b>${transaction_status_code}</li>`;
              let transaction_status_description = $(this).data('transaction_status_description');
              appendedTags += `<li><span>Disbursement Status Description</span><b>:</b>${transaction_status_description}</li>`;
            let doc_id = $(this).data('doc_id');
            appendedTags += `<li><span>Document ID</span><b>:</b>${doc_id}</li>`;
            let doc_maker = $(this).data('doc_maker');
            appendedTags += `<li><span>Maker user</span><b>:</b>${doc_maker}</li>`;
            let doc_checker = $(this).data('doc_checker');
            appendedTags += `<li><span>Checker user</span><b>:</b>${doc_checker}</li>`;
            ul.empty();
            ul.append(appendedTags);
            $("#trxDetails").show();
            $('html,body').animate({
                scrollTop: $("#trxDetails").offset().top
            }, 'slow');
       }
    });
  </script>

{% endblock %}
