{% extends 'new_base.html' %}
{% load static %}
{% load i18n %}

{% block title %}
  {% if request.user.is_accept_vodafone_onboarding %}
    {% trans "Vodafone/Etisalat/Aman Disbursement Files" %}
  {% else %}
    {% trans "Disbursement Files" %}
  {% endif %}
{% endblock title %}

{% block gentellacss %}
<link rel="stylesheet" href="{% static 'gentella/vendors/dropzone/dist/min/dropzone.min.css' %}">
<!-- Datatables -->
<link href="{% static 'gentella/vendors/datatables.net-bs/css/dataTables.bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'gentella/vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'gentella/vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'gentella/vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'gentella/vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css' %}" rel="stylesheet">
{% endblock gentellacss %}

{% block body %}
    {% if not has_vmt_setup or not request.user.is_root and not has_any_file_category %}
        <div class="well upload-nav col-xs-12">
            <strong style="margin-top: 15px;">{% trans 'Account is suspended due to uncompleted setups of your Admin!' %}</strong>
        </div>

    {% elif not admin_is_active %}
        <div class="well upload-nav col-xs-12">
            {% if request.user.is_root %}
                <strong style="margin-top: 15px;">{% trans "You're not active any more!" %}</strong>
            {% else %}
                <strong style="margin-top: 15px;">{% trans 'Your Admin is no longer active!' %}</strong>
            {% endif %}
        </div>

    {% elif has_any_file_category and user_has_upload_perm %}
        <div class="well upload-nav col-xs-12">
            <h3 class="navbar-left col-xs-12">{% trans 'Upload Form' %}</h3>
            <div class="form-group col-xs-12">
                <label class="control-label col-md-1 col-sm-1 col-xs-1">{% trans 'Select Format' %}</label>
                <div class="col-md-6 col-sm-6 col-xs-12">
                    <select class="form-control" name="file_category" id="category">
                        {% for format in family_file_categories %}
                            <option value="{{ format.id }}">{{ format.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="x_content">
                <form id="fileUpload" class="dropzone" action=" {% url 'data:e_wallets_home' %}" method="post"
                    enctype="multipart/form-data">{% csrf_token %}
                </form>
            </div>
        </div>
    {% endif %}

    {% if request.user.is_accept_vodafone_onboarding %}
      {% include 'data/document_disbursement_list.html' with object_list=doc_list_disbursement list_header='Vodafone/Etisalat/Aman' %}
    {% else %}
      {% include 'data/document_disbursement_list.html' with object_list=doc_list_disbursement %}
    {% endif %}

    {# Modals - uploading sheets and deleting documents #}
    {% include 'data/upload-response-modals.html' %}
    {% include 'data/document_delete_modal.html' %}
    {# End of Modals - uploading sheets and deleting documents  #}
{% endblock body %}


{% block script %}

<!-- Dropzone.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="{% static 'gentella/vendors/dropzone/dist/min/dropzone.min.js' %}"></script>
<!-- Datatables -->
<script src="{% static 'gentella/vendors/datatables.net/js/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons/js/buttons.flash.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons/js/buttons.html5.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-buttons/js/buttons.print.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-keytable/js/dataTables.keyTable.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-responsive/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js' %}"></script>
<script src="{% static 'gentella/vendors/datatables.net-scroller/js/dataTables.scroller.min.js' %}"></script>

<script>
    $(function () {
        Dropzone.options.fileUpload = {
            maxFiles: 1,
            dictDefaultMessage: '{% trans "Drop a file here to upload or click to browse one" %}',
            accept: function (file, done) {
                bootbox.confirm("Upload file?", function (result) {
                    if (result) {
                        done();
                    }
                    else {
                        done('Upload cancelled');
                    }
                });
            },
            init: function () {
                this.on("success", function (file, a, b) {
                    $('#success-modal').modal('show');
                    this.removeAllFiles();
                });
                this.on("error", function (file, message, obj) {
                    this.removeAllFiles();
                    var fail_modal = $('#fail-modal');
                    if (message['file'])
                        fail_modal.find('.modal-body #p1').text(message.file[0]);
                    if (message['non_field_errors'])
                        fail_modal.find('.modal-body #p2').text(message.non_field_errors[0]);
                    if (message === 'Upload cancelled')
                        fail_modal.find('.modal-body #p1').text(message);

                    fail_modal.modal('show');
                });
                this.on('sending', function (file, xhr, formData) {
                    // add format to upload form
                    if ($('#category').length) {
                        formData.append('file_category', $('#category').val());
                    }
                });
            }
        }
    });
</script>

<script>
    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    })
    
    $('#export_e_wallets_sample_file').on('click', function () {
      window.open('{% url 'disbursement:export_sample_file' %}?type=e_wallets', '_blank');
    });
</script>

    {% include 'data/document_delete_script.html' %}
{% endblock script %}